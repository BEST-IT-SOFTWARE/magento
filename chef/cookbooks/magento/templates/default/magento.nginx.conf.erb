server {
	server_name <%= @web_address %>;
	index index.php;
	root <%= @web_root %>;
	
	location ~ /skin/m {
		rewrite  ^/skin/m/([^/]+)(/.*.(js|css))$  /lib/minify/m.php?f=$2&d=$1 last;
	}
	error_log	/vagrant/var/log/php-error.log notice;
    location ~ /cached_(catalogevent_)?media\.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_read_timeout 30;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
        include fastcgi_params;
        fastcgi_param IS_IMAGES_PROCESSOR 1;
    }

    location ~ ^/media/catalog/product/cache/ {
        try_files $uri /cached_media.php;
    }

    location ~  ^/media/enterprise/catalogevent/resize/ {
        try_files $uri /cached_catalogevent_media.php;
    }

	location ~ ^/(media|skin|js)/ {
		try_files $uri =404;
	}

	location / {
		try_files $uri $uri/ /index.php?$args;
	}

    location ~ \.php$ {
		try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_read_timeout 600;
		fastcgi_pass unix:/var/run/php-fpm-www.sock;
        fastcgi_index index.php;
        include fastcgi_params;
		fastcgi_param MAGE_IS_DEVELOPER_MODE 1;
	}

	location ~ /\.ht {
	    deny  all;
	}
}